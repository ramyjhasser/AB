---
title: "inesgeneroab"
author: "R Jhasser"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Cargar librerías
library(bibliometrix)
library(dplyr)
library(stringr)
library(ggplot2)
library(wordcloud)
library(RColorBrewer)
library(Cairo)
library(tidyverse)
library(kableExtra)
library(plotly)
library(networkD3)
library(igraph)
library(corrplot)
library(gridExtra)
library(viridis)
library(reshape2)
library(scales)
install.packages(c("rnaturalearth", "rnaturalearthdata", "sf"))  # una sola vez
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)

setwd("~/Documents/GitHub/AB/DATA")

files <- list.files(path = "../DATA", full.names = TRUE)

files

# Convierte cada archivo a data frame
bib_list <- lapply(files, function(f) {
  convert2df(file = f, dbsource = "isi", format = "bibtex")
})

# Une todos los data frames y elimina duplicados
M <- mergeDbSources(bib_list, remove.duplicated = TRUE)

# Unir todos los dataframes en uno solo
M <- mergeDbSources(bib_list, remove.duplicated = TRUE)

# Confirmar cuántos registros tienes
nrow(M)

# Crear el objeto de análisis bibliométrico
results <- biblioAnalysis(M)


# Resumen general
S <- summary(object = results,
             k = 50, pause = FALSE)

C <- S$TCperCountries
write.csv(C, "../DATA/Country.csv", row.names = FALSE)

# ---- Packages (instala una vez si falta alguno) ----
# install.packages(c("dplyr","stringr","countrycode","sf","rnaturalearth",
#                    "rnaturalearthdata","ggplot2","patchwork","scales",
#                    "gridExtra","ggplotify","viridis"))
library(dplyr)
library(stringr)
library(countrycode)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggplot2)
library(patchwork)
library(scales)
library(gridExtra)
library(ggplotify)
library(viridis)


# --------------------------
# 1) TABLA: Total citations per country (S$TCperCountries)
# --------------------------
C <- as.data.frame(S$TCperCountries)
names(C) <- make.unique(trimws(names(C)))  # arregla duplicados/espacios

# Columnas esperadas: Country | TC | AAC (pero lo hacemos robusto)
library(dplyr)
library(stringr)

C <- as.data.frame(S$TCperCountries)
names(C) <- make.unique(trimws(names(C)))

pick1 <- function(x, fallback) if (!is.na(x) && length(x) > 0) x else fallback

country_col <- names(C)[1]
tc_guess  <- names(C)[str_detect(names(C), regex("TC|Total", ignore_case = TRUE))][1]
aac_guess <- names(C)[str_detect(names(C), regex("AAC|Average", ignore_case = TRUE))][1]

tc_col  <- pick1(tc_guess,  names(C)[2])
aac_col <- pick1(aac_guess, names(C)[3])

C2 <- C %>%
  transmute(
    country = str_squish(.data[[country_col]]),
    total_citations = as.numeric(.data[[tc_col]]),
    avg_article_citations = as.numeric(.data[[aac_col]])
  )

head(C2)

# ISO3 para join limpio con el mapa
install.packages("countrycode")   # una sola vez
library(countrycode)
C2 <- C2 %>%
  mutate(
    iso3 = countrycode(country, origin = "country.name", destination = "iso3c")
  ) %>%
  mutate(
    iso3 = case_when(
      country %in% c("USA", "UNITED STATES", "UNITED STATES OF AMERICA") ~ "USA",
      country %in% c("UNITED KINGDOM", "ENGLAND", "SCOTLAND", "WALES")    ~ "GBR",
      TRUE ~ iso3
    )
  )

# --------------------------
# 2) TABLA: Publications per country (S$MostProdCountries)
# --------------------------
P <- as.data.frame(S$MostProdCountries)
names(P) <- make.unique(trimws(names(P)))

p_country_col <- names(P)[1]
p_docs_col    <- names(P)[2]

P2 <- P %>%
  transmute(
    country = str_squish(.data[[p_country_col]]),
    documents = as.numeric(.data[[p_docs_col]])
  )
install.packages(c("rnaturalearth","rnaturalearthdata","sf"))
library(sf)
# --------------------------
# 3) MAPA (A): Total citations
# --------------------------
world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  select(iso3 = iso_a3, name_long, geometry)

map_dat <- world %>% left_join(C2, by = "iso3")

p_map <- ggplot(map_dat) +
  geom_sf(aes(fill = total_citations), color = NA) +
  scale_fill_viridis_c(option = "C", trans = "log10", na.value = "grey90", labels = comma) +
  labs(fill = "Total citations") +
  theme_void()

# --------------------------
# 4) BARRAS (B): Top 10 countries by publications
# --------------------------
p_pub <- P2 %>%
  arrange(desc(documents)) %>%
  slice_head(n = 10) %>%
  ggplot(aes(x = reorder(country, documents), y = documents)) +
  geom_col() +
  coord_flip() +
  labs(x = NULL, y = "Number of publications") +
  theme_minimal(base_size = 10)

# --------------------------
# 5) BARRAS (C): Top 10 countries by total citations
# --------------------------
p_cit <- C2 %>%
  arrange(desc(total_citations)) %>%
  slice_head(n = 10) %>%
  ggplot(aes(x = reorder(country, total_citations), y = total_citations)) +
  geom_col() +
  coord_flip() +
  labs(x = NULL, y = "Total citations") +
  theme_minimal(base_size = 10)

# --------------------------
# 6) FIGURA COMPUESTA (A,B,C) + Guardar
# --------------------------
fig_ABC <- (p_map / (p_pub | p_cit)) + plot_annotation(tag_levels = "A")
ggsave("Figure_CountryMap_Publications_Citations3.png", fig_ABC,
       width = 10, height = 7, dpi = 600)


# --------------------------
# 6) FIGURA COMPUESTA (A,B,C) + Guardar  
# --------------------------
library(patchwork)

fig_ABC <- (p_map / (p_pub | p_cit)) +
  plot_layout(heights = c(3.2, 1)) +  # <-- mapa 3.2x más alto que la fila de barras
  plot_annotation(
    tag_levels = "A",
    tag_prefix = "(", tag_suffix = ")"
  ) &
  theme(
    plot.tag = element_text(face = "bold", size = 14),
    plot.margin = margin(2, 2, 2, 2)
  )

ggsave("Figure_CountryMap_Publications_Citations5.png", fig_ABC,
       width = 10, height = 7, dpi = 600)

graph<-plot(x = results, k = 10, pause = FALSE)
plot(results, k = 10, pause = FALSE)


graph$MostProdAuthors
graph$MostProdCountries
graph$AnnualScientProd
graph$AverArtCitperYear
graph$AverTotCitperYear





# ---- FIG 1: Producción anual (desde DATA)
ap <- M %>%
  mutate(PY = as.integer(PY)) %>%
  filter(!is.na(PY)) %>%
  count(PY, name = "Articles") %>%
  arrange(PY)

p1 <- ggplot(ap, aes(PY, Articles)) +
  geom_col() + geom_line() + geom_point() +
  labs(title = "Annual Scientific Production", x = "Year", y = "Documents") +
  theme_minimal(base_size = 13)

print(p1)
ggsave("ines_figs/Fig1_AnnualProduction.png", p1, width=10, height=5, dpi=350)

library(ggplot2)

dir.create("ines_figs", showWarnings = FALSE)

src <- as.data.frame(results$Sources)     # columnas: SO y Freq
src <- src[1:10, , drop = FALSE]
names(src) <- c("Source","Articles")

p2 <- ggplot(src, aes(x = reorder(Source, Articles), y = Articles)) +
  geom_col() + coord_flip() +
  labs(title = "Most Relevant Sources (Top 10)", x = NULL, y = "Documents") +
  theme_minimal(base_size = 13)

p2
ggsave("ines_figs/Fig2_TopSources.png", p2, width=9, height=5, dpi=350)

#PRODUCTIVE COUNTRY 
library(ggplot2)
library(dplyr)

ctry <- as.data.frame(S$MostProdCountries)[1:10, , drop=FALSE]

# Asegurar nombres (por si vienen raros)
if (!"Country"  %in% names(ctry)) names(ctry)[1] <- "Country"
if (!"Articles" %in% names(ctry)) names(ctry)[2] <- "Articles"

# Convertir tipos (esto arregla el error)
ctry$Country  <- as.character(ctry$Country)
ctry$Articles <- ctry$Articles %>% unlist() %>% as.character()
ctry$Articles <- as.numeric(gsub("[^0-9.]", "", ctry$Articles))  # limpia símbolos

# Plot
p3 <- ggplot(ctry, aes(x = reorder(Country, Articles), y = Articles)) +
  geom_col() + coord_flip() +
  labs(title = "Most Productive Countries (Top 10)", x = NULL, y = "Documents") +
  theme_minimal(base_size = 13)

p3
ggsave("ines_figs/Fig3_TopCountries.png", p3, width=9, height=5, dpi=350)

#KEY WORD 
library(ggplot2)

kw <- as.data.frame(S$MostRelKeywords)

de <- data.frame(
  Keyword  = kw[[1]],
  Articles = as.numeric(gsub("[^0-9.]", "", kw[[2]]))
)

p4 <- ggplot(de, aes(reorder(Keyword, Articles), Articles)) +
  geom_col() + coord_flip() +
  theme_minimal(base_size=13) +
  labs(title="Top Author Keywords (DE) (Top 10)", x=NULL, y="Documents")

p4
ggsave("ines_figs/Fig4_TopKeywords_DE.png", p4, width=9, height=5, dpi=350)

id <- data.frame(
  Keyword  = kw[[3]],
  Articles = as.numeric(gsub("[^0-9.]", "", kw[[4]]))
)

p5 <- ggplot(id, aes(reorder(Keyword, Articles), Articles)) +
  geom_col() + coord_flip() +
  theme_minimal(base_size=13) +
  labs(title="Top Keywords Plus (ID) (Top 10)", x=NULL, y="Documents")

p5
ggsave("ines_figs/Fig5_TopKeywords_ID.png", p5, width=9, height=5, dpi=350)


# ===== FIG 6: Most Cited Papers (Top 10) =====
cp <- as.data.frame(S$MostCitedPapers)[1:10, , drop=FALSE]

# En tu summary suele venir "Paper" y "TC"
# Forzamos columnas por posición si cambian nombres:
if (!"Paper" %in% names(cp)) cp$Paper <- cp[[1]]
if (!"TC"    %in% names(cp)) cp$TC    <- cp[["TC"]]

# asegurar TC numérico
cp$TC <- as.numeric(gsub("[^0-9.]", "", as.character(cp$TC)))

p6 <- ggplot(cp, aes(x = reorder(Paper, TC), y = TC)) +
  geom_col() + coord_flip() +
  labs(title="Most Cited Papers (Top 10)", x=NULL, y="Total Citations (TC)") +
  theme_minimal(base_size = 13)

p6
ggsave("ines_figs/Fig6_MostCitedPapers.png", p6, width=12, height=6, dpi=350)

dir.create("ines_figs", showWarnings = FALSE)
write.csv(S$MainInformationDF, "ines_figs/Table1_MainInformation.csv", row.names = FALSE)


library(bibliometrix)

library(bibliometrix)

NetAuth <- biblioNetwork(M, analysis="collaboration", network="authors", sep=";")

dir.create("ines_figs/layout_tests", recursive = TRUE, showWarnings = FALSE)

types <- c("fruchterman","kamada","lgl","mds","circle","grid","random")

for (tp in types) {
  outfile <- paste0("ines_figs/layout_tests/AuthorNet_", tp, ".png")
  message("Saving: ", outfile)

  try({
    png(outfile, width=2200, height=1400, res=250)
    networkPlot(NetAuth,
                n = 40,
                type = tp,
                size = TRUE,
                labelsize = 0.5,
                remove.isolates = TRUE,
                Title = paste("Author collaboration network -", tp))
    dev.off()
  }, silent = TRUE)
}
dev.off()

png("ines_figs/AuthorNet_kamada_ultra.png", width=2400, height=1500, res=300)
networkPlot(NetAuth, n=25, type="kamada", size=TRUE, labelsize=0.7,
            remove.isolates=TRUE, Title="Author collaboration network (ultra clear)")


library(bibliometrix)

# crea el campo AU_CO a partir de C1/RP
M2 <- metaTagExtraction(M, Field = "AU_CO", sep = ";")

# chequeo rápido
table(is.na(M2$AU_CO))
head(M2$AU_CO, 10)

library(bibliometrix)

dir.create("ines_figs", showWarnings = FALSE)

# filtra el único NA por seguridad
M2_ok <- M2[!is.na(M2$AU_CO) & trimws(M2$AU_CO) != "", ]

NetC <- biblioNetwork(M2_ok, analysis="collaboration", network="countries", sep=";")

png("ines_figs/Fig_CountryCollabNetwork_kamada.png", width=2200, height=1400, res=250)
networkPlot(NetC, n=50, type="fruchterman",
            size=TRUE, labelsize=0.7,
            remove.isolates=TRUE,
            Title="Country collaboration network")

# Usa DE (Author Keywords). Si DE está pobre, cambia field="ID".
png("ines_figs/Fig_ThematicMap.png", width = 1600, height = 1100, res = 200)
thematicMap(M, field = "DE", n = 250, minfreq = 5, stemming = FALSE, size = 0.5, n.labels = 1)
dev.off()

library(dplyr)
library(ggplot2)

dir.create("ines_figs", showWarnings = FALSE)

# texto combinado (robusto)
txt <- paste(
  ifelse(is.na(M$TI), "", M$TI),
  ifelse(is.na(M$AB), "", M$AB),
  ifelse(is.na(M$DE), "", M$DE),
  ifelse(is.na(M$ID), "", M$ID)
)

# detectar menciones
female <- grepl("\\bfemales?\\b", txt, ignore.case = TRUE)
male   <- grepl("\\bmales?\\b",   txt, ignore.case = TRUE)

# clasificar
sex_focus <- dplyr::case_when(
  female & !male ~ "Female only",
  male & !female ~ "Male only",
  female & male  ~ "Both sexes",
  TRUE           ~ "Not specified"
)

# tabla + plot
df_sex <- as.data.frame(table(sex_focus)) %>%
  rename(Category = sex_focus, Documents = Freq) %>%
  arrange(desc(Documents))

p_sex <- ggplot(df_sex, aes(x = reorder(Category, Documents), y = Documents)) +
  geom_col() + coord_flip() +
  labs(title = "Sex reporting proxy (mentions in TI/AB/DE/ID)",
       x = NULL, y = "Documents") +
  theme_minimal(base_size = 13)

p_sex
ggsave("ines_figs/Fig_SexMentionsProxy.png", p_sex, width=9, height=5, dpi=350)

df_sex

trend_df2 <- trend_df %>% filter(Freq >= 2)

p_bubble2 <- ggplot(trend_df2, aes(x = PY, y = DE, size = Freq)) +
  geom_point(alpha = 0.75) +
  labs(title = "Trend Topics (DE) - Top 20 (Freq ≥ 2/year)",
       x = "Year", y = "Term") +
  theme_minimal(base_size = 12)

p_bubble2
ggsave("ines_figs/Fig_TrendTopics_bubble_clean.png", p_bubble2, width=12, height=8, dpi=350)


library(dplyr)
library(ggplot2)
library(stringr)

dir.create("ines_figs", showWarnings = FALSE)

# Texto + año (usa TI/AB/DE/ID)
df_sex_year <- M %>%
  transmute(
    PY  = as.integer(PY),
    txt = paste(
      ifelse(is.na(TI), "", TI),
      ifelse(is.na(AB), "", AB),
      ifelse(is.na(DE), "", DE),
      ifelse(is.na(ID), "", ID)
    )
  ) %>%
  filter(!is.na(PY), PY >= 2008) %>%
  mutate(
    female = str_detect(txt, regex("\\bfemales?\\b", ignore_case = TRUE)),
    male   = str_detect(txt, regex("\\bmales?\\b",   ignore_case = TRUE)),
    Category = case_when(
      female & !male ~ "Female only",
      male & !female ~ "Male only",
      female & male  ~ "Both sexes",
      TRUE           ~ "Not specified"
    )
  ) %>%
  count(PY, Category, name="Documents") %>%
  group_by(PY) %>%
  mutate(Percent = Documents / sum(Documents) * 100) %>%
  ungroup()

# Plot en porcentaje (mejor para comparar años)
p_sex_year <- ggplot(df_sex_year, aes(x = PY, y = Percent, group = Category)) +
  geom_line() +
  geom_point(size = 1.8) +
  labs(title = "Sex reporting proxy over time (TI/AB/DE/ID)",
       x = "Year", y = "Percent of documents") +
  theme_minimal(base_size = 13)

p_sex_year
ggsave("ines_figs/Fig_SexProxy_overTime.png", p_sex_year, width=10, height=6, dpi=350)

library(dplyr)
library(ggplot2)


# 1) Conteo anual (records por año)
ap <- M %>%
  mutate(PY = as.numeric(PY)) %>%
  filter(!is.na(PY)) %>%
  count(PY, name = "Records") %>%
  arrange(PY)

# (opcional) completar años faltantes dentro del rango
ap <- ap %>%
  tidyr::complete(PY = seq(min(PY), max(PY), by = 1), fill = list(Records = 0))

# 2) Plot tipo “Figure 1. Articles published per year”
p_pub <- ggplot(ap, aes(x = PY, y = Records)) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 2.2) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dotted", linewidth = 0.9) +
  labs(
    title = NULL,
    x = "Publication Year",
    y = "Records"
  ) +
  theme_classic(base_size = 16) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )

p_pub

# 3) Guardar
dir.create("ines_figs", showWarnings = FALSE)
ggsave("ines_figs/Fig_PubsPerYear_PaperStyle.png", p_pub, width = 10, height = 6, dpi = 350)

library(bibliometrix)

# si tu dataset se llama merged_bib y no M:
if (!exists("M")) M <- merged_bib

dir.create("ines_figs", showWarnings = FALSE)

# --- Red (matriz) de coautoría
png("ines_figs/Fig_AuthorCollaboration.png", width = 2600, height = 1900, res = 300)

png("ines_figs/Fig_AuthorCollaboration_clean.png", width = 2600, height = 1900, res = 300)

# asumiendo que ya tienes g, lay (kamada), y comunidades en V(g)$comm

# install.packages(c("wordcloud2", "dplyr"))
library(dplyr)
library(wordcloud2)

rk <- S$MostRelKeywords

# 1) Arregla nombres duplicados (Articles -> Articles, Articles.1)
names(rk) <- make.unique(trimws(names(rk)))

names(rk)  # para verificar

# 2) Construye dataframes para wordcloud
kw_de <- data.frame(
  word = rk[[1]],
  freq = as.numeric(rk[[2]])
) %>% 
  filter(!is.na(word), !is.na(freq), freq > 1)

kw_id <- data.frame(
  word = rk[[3]],
  freq = as.numeric(rk[[4]])
) %>% 
  filter(!is.na(word), !is.na(freq), freq > 1)

# 3) Wordclouds
wordcloud2(kw_de, size = 0.5, rotateRatio = 0, shuffle = FALSE)
wordcloud2(kw_id, size = 0.7, rotateRatio = 0, shuffle = FALSE)




```


knitr::opts_chunk$set(echo = TRUE)



```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
